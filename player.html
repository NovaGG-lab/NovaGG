<!DOCTYPE html>
<html>
<head>
  <title>NovaGG Player</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    canvas { display: block; }

    #chat {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 10px;
      max-width: 300px;
      color: white;
    }

    #messages {
      max-height: 150px;
      overflow-y: auto;
      font-size: 14px;
    }

    #messageInput {
      width: 100%;
      border: none;
      padding: 5px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="chat">
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message..." />
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>

  <script>
    const socket = io("http://localhost:3000");

    let scene, camera, renderer;
    let myId = null;
    let isFirstPerson = true;
    const players = {};
    const keys = {};
    const messages = document.getElementById('messages');
    const input = document.getElementById('messageInput');

    // Add message to chat
    function addMessage(msg) {
      const el = document.createElement('div');
      el.textContent = msg;
      messages.appendChild(el);
      messages.scrollTop = messages.scrollHeight;
    }

    // Chat Input
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && input.value.trim()) {
        socket.emit('chat', input.value.trim());
        input.value = '';
      }
    });

    socket.on('chat', ({ username, message }) => {
      addMessage(`${username}: ${message}`);
    });

    socket.on('system', (message) => {
      addMessage(`[SYSTEM] ${message}`);
    });

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87ceeb); // blue sky

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // Baseplate
      const groundGeo = new THREE.BoxGeometry(100, 1, 100);
      const groundMat = new THREE.MeshBasicMaterial({ color: 0x444444 });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.position.y = -0.5;
      scene.add(ground);

      window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
      window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

      window.addEventListener('click', () => {
        if (document.pointerLockElement !== renderer.domElement) {
          renderer.domElement.requestPointerLock();
        }
      });

      document.addEventListener('mousemove', (e) => {
        if (document.pointerLockElement === renderer.domElement && myId && players[myId]) {
          players[myId].group.rotation.y -= e.movementX * 0.002;
        }
      });

      animate();
    }

    function createPlayer(username) {
      const group = new THREE.Group();

      const body = new THREE.Mesh(
        new THREE.CylinderGeometry(0.5, 0.5, 1.5, 8),
        new THREE.MeshBasicMaterial({ color: 0x00ff00 })
      );
      const head = new THREE.Mesh(
        new THREE.SphereGeometry(0.5, 8, 8),
        new THREE.MeshBasicMaterial({ color: 0x00ff00 })
      );
      head.position.y = 1;

      const nameTag = document.createElement('div');
      nameTag.style.position = 'absolute';
      nameTag.style.color = 'white';
      nameTag.style.fontSize = '12px';
      nameTag.style.fontWeight = 'bold';
      document.body.appendChild(nameTag);

      group.add(body);
      group.add(head);

      return { group, nameTag, username };
    }

    function updateNameTags() {
      Object.values(players).forEach(({ group, nameTag, username }) => {
        const vector = group.position.clone().project(camera);
        const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
        const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;
        nameTag.style.left = `${x}px`;
        nameTag.style.top = `${y}px`;
        nameTag.textContent = username;
      });
    }

    function moveLocalPlayer() {
      if (!myId || !players[myId]) return;

      const me = players[myId];
      const speed = 0.1;
      const dir = new THREE.Vector3();

      if (keys['w']) dir.z -= 1;
      if (keys['s']) dir.z += 1;
      if (keys['a']) dir.x -= 1;
      if (keys['d']) dir.x += 1;

      dir.normalize().applyAxisAngle(new THREE.Vector3(0, 1, 0), me.group.rotation.y);
      me.group.position.addScaledVector(dir, speed);

      socket.emit("move", { x: me.group.position.x, z: me.group.position.z });
    }

    function animate() {
      requestAnimationFrame(animate);
      moveLocalPlayer();

      if (myId && players[myId]) {
        const me = players[myId];
        const eye = me.group.position.clone().add(new THREE.Vector3(0, 1.2, 0));
        if (isFirstPerson) {
          camera.position.copy(eye);
          const dir = new THREE.Vector3(0, 0, -1).applyAxisAngle(new THREE.Vector3(0, 1, 0), me.group.rotation.y);
          camera.lookAt(eye.clone().add(dir));
        } else {
          const offset = new THREE.Vector3(0, 2, 5).applyAxisAngle(new THREE.Vector3(0, 1, 0), me.group.rotation.y);
          camera.position.copy(eye.clone().add(offset));
          camera.lookAt(eye);
        }
      }

      renderer.render(scene, camera);
      updateNameTags();
    }

    socket.on("connect", () => {
      const username = prompt("Enter your username:");
      myId = socket.id;
      socket.emit("join", { username });
    });

    socket.on("playerData", (data) => {
  data.forEach(({ id, username, position }) => {
    if (!players[id]) {
      const { group, nameTag } = createPlayer(username);
      scene.add(group);
      players[id] = { group, nameTag, username };
    }

    if (position) {
      players[id].group.position.set(position.x, 0, position.z);
    }
  });
});



    socket.on("playerMoved", ({ id, position }) => {
      if (players[id]) {
        players[id].group.position.set(position.x, 0, position.z);
      }
    });

    socket.on("playerLeft", (id) => {
      if (players[id]) {
        scene.remove(players[id].group);
        document.body.removeChild(players[id].nameTag);
        delete players[id];
      }
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === 'v') isFirstPerson = !isFirstPerson;
    });

    window.addEventListener("beforeunload", () => {
      socket.emit("leave");
    });

    init();
  </script>
</body>
</html>
