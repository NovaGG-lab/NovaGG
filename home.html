<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    query,
    where,
    getDocs,
    doc,
    deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAzJdwswNquD0j1HrM-UzlfRr59q4KUxx4",
    authDomain: "novagg-5bd3a.firebaseapp.com",
    projectId: "novagg-5bd3a",
    storageBucket: "novagg-5bd3a.appspot.com",
    messagingSenderId: "672962665712",
    appId: "1:672962665712:web:4ed2f4a3c858ef9beeb635",
    measurementId: "G-0P30E7HKZN"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser;

  onAuthStateChanged(auth, async (user) => {
    if (user && user.emailVerified) {
      currentUser = user;
      document.getElementById("usernameDisplay").textContent = user.displayName || user.email;
      document.getElementById("userPFP").src = user.photoURL || "https://via.placeholder.com/40";
      loadGames();
    } else {
      window.location.href = "login.html";
    }
  });

  async function loadGames() {
    const gamesList = document.getElementById("gamesList");
    const gameDetails = document.getElementById("gameDetails");
    gamesList.querySelectorAll('.game-item').forEach(n => n.remove());

    const q = query(collection(db, "games"), where("show", "==", true));
    const querySnapshot = await getDocs(q);

    querySnapshot.forEach(docSnap => {
      const game = docSnap.data();
      const gameItem = document.createElement("div");
      gameItem.classList.add("game-item");
      gameItem.innerHTML = `
        <img src="${game.icon}" alt="${game.name} Icon" class="game-icon" />
        <div>
          <div class="game-name">${game.name}</div>
          <small>By: ${game.creatorName}</small>
        </div>
      `;
      gameItem.addEventListener("click", () => {
        gameDetails.innerHTML = `
          <h2>${game.name}</h2>
          <p>${game.desc}</p>
          <p><strong>Created by:</strong> ${game.creatorName}</p>
        `;

        if (currentUser.uid === game.creatorUID) {
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Delete Game";
          deleteBtn.style.marginTop = "10px";
          deleteBtn.addEventListener("click", async () => {
            await deleteDoc(doc(db, "games", docSnap.id));
            alert("Game deleted.");
            loadGames();
          });
          gameDetails.appendChild(deleteBtn);
        }
      });

      gamesList.appendChild(gameItem);
    });
  }

  // Game Creation Form
  document.getElementById("createGameForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("gameName").value.trim();
    const desc = document.getElementById("gameDesc").value.trim();
    const icon = document.getElementById("gameIcon").value.trim();

    if (!currentUser) return alert("User not logged in");

    await addDoc(collection(db, "games"), {
      name,
      desc,
      icon,
      creatorUID: currentUser.uid,
      creatorName: currentUser.displayName || currentUser.email,
      show: true,
      createdAt: serverTimestamp()
    });

    alert("Game created!");
    document.getElementById("createGameForm").reset();
    loadGames();
  });

  // Dropdown logic
  const tabs = document.querySelectorAll(".tab-button");
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      const isActive = tab.classList.contains("active");
      tabs.forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".dropdown-content").forEach(d => d.style.display = "none");
      if (!isActive) {
        tab.classList.add("active");
        tab.nextElementSibling.style.display = "block";
      }
    });
  });
</script>
